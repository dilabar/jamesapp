

    
    {% extends 'new/base.html' %}
    {% load static %}
    
    {% block header %}
    
    {% endblock header %}
    
    {% block css %}
    <link rel="stylesheet" type="text/css" href="{% static 'manish/css/vendors/datatables.css' %}">
    {% endblock css %}
        
    
    
    {% block body %}
    
    <div class="page-body">
        <div class="container-fluid">
            <div class="page-title">
                <div class="row">
                    <div class="col-6">
                        <h4>{{ list.name }}</h4> <!-- Displaying the list name -->
                    </div>
                    <div class="col-6">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#">                                       
                                <svg class="stroke-icon">
                                    <use href="{% static 'manish/svg/icon-sprite.svg' %}#stroke-home"></use>
                                </svg></a></li>
                            <li class="breadcrumb-item">Agents</li>
                            <li class="breadcrumb-item active">Call History</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        <!-- Container-fluid starts-->
        <div class="container-fluid">
            <div class="row">
                <!-- Scroll - vertical dynamic Starts-->
                <div class="col-sm-12">
                    <div class="card">
                        <div class="card-header pb-0 card-no-border">
                            <a href="{% url 'contact:add_contact' %}" class="btn btn-primary" data-bs-toggle="tooltip" title="Add Contact">Add Contact</a>
                            {% comment %} <a href="{% url 'contact:upload_excel' %}" class="btn btn-primary" data-bs-toggle="tooltip" title="Bulk Add">Bulk Add</a> {% endcomment %}
                            <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target=".bd-example-modal-lg">Bulk Add</button>
                            <span>Easily manage your AI Agents by editing, deleting, or initiating a conversation directly from the table.</span>
                        </div>
                        <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myExtraLargeModal" aria-hidden="true">
                            <div class="modal-dialog modal-lg modal-dialog-centered">
                              <div class="modal-content">
                                <div class="modal-header">
                                  <h4 class="modal-title" id="myExtraLargeModal">Add Bulk Contact</h4>
                                  <button class="btn-close py-0" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body dark-modal"> 
                                  <form id="multiStepForm" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                                    {% csrf_token %}
                                    <div class="step step-1">
                                        <h5 class="mb-3">Step 1: Upload CSV File</h5>
                                        <div class="mb-3">
                                            <label class="form-label" for="file_upload">CSV List</label>
                                            <input class="form-control" id="file_upload" name="file_upload" type="file" required>
                                            <div class="invalid-feedback">Please upload a valid CSV file.</div>
                                        </div>
                                    </div>
                
                                    <div class="step step-2 d-none">
                                        <h5 class="mb-3">Step 2: Map Columns</h5>
                                        <div id="mapping-container">
                                            <table class="table table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>Column Header in File</th>
                                                        <th>Mapped Field</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="mapping-table">
                                                    <!-- Dynamic mapping rows will be generated here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                
                                    <div class="step step-3 d-none">
                                        <h5 class="mb-3">Step 3: Select Action</h5>
                                        <div class="mb-4">
                                            <label class="form-label d-block">Select an Option</label>
                                            <div class="d-flex align-items-center">
                                                <div class="form-check me-3">
                                                    <input class="form-check-input" type="radio" name="options" id="create" value="create" required>
                                                    <label class="form-check-label" for="create">Create Contacts</label>
                                                </div>
                                                <div class="form-check me-3">
                                                    <input class="form-check-input" type="radio" name="options" id="create_update" value="create_update" required>
                                                    <label class="form-check-label" for="create_update">Create and Update Contacts</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="options" id="update" value="update" required>
                                                    <label class="form-check-label" for="update">Update Contacts</label>
                                                </div>
                                            </div>
                                            <div class="invalid-feedback">Please select an option.</div>
                                        </div>
                                    </div>
                                  </form>
                                </div>
                                <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                  <button type="button" class="btn btn-primary" id="prevStep" disabled>Previous</button>
                                  <button type="button" class="btn btn-primary" id="nextStep">Next</button>
                                  <button type="submit" class="btn btn-success d-none" id="submitForm">Submit</button>
                                </div>
                              </div>
                            </div>
                          </div>

    
                        <div class="card-body">
                            <!-- List Details Section -->
                            
    
                            <!-- Table Section for Contact Details -->
                            <div class="table-responsive user-datatable custom-scrollbar">
                                <table class="display" id="basic-10">
                                    <thead>
                                        <tr>
                                           
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone Number</th>
                                            <th>Created</th>
                                            <th>Contact Type</th>
                                            <th>Time Zone</th>
                                            <th>Lists</th> <!-- New column for Lists -->
                                            <th>Campaigns</th> <!-- New column for Campaigns -->
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for contact in list.contacts.all %}
                                        <tr>
                                            
                                            <td>{{ contact.first_name }} {{ contact.last_name }}</td>
                                            <td>
                                                {% for email in contact.emails.all %}
                                                    {{ email.email }}{% if email.is_primary %} (Primary){% endif %}{% if not forloop.last %}, {% endif %}
                                                {% empty %}
                                                    No emails
                                                {% endfor %} 
                                              
                                              </td>
                                              <td>  {% for phone in contact.phone_numbers.all %}
                                                {{ phone.phone_number }}{% if phone.is_primary %} (Primary){% endif %}{% if not forloop.last %}, {% endif %}
                                            {% empty %}
                                                No phone numbers available
                                            {% endfor %}</td>
                                            <td>{{ contact.created_at|date:"F d, Y" }}</td>
                                            <td>{{ contact.contact_type }}</td>
                                            <td>{{ contact.time_zone }}</td>
                                            <td>
                                                {% if contact.lists.exists %}
                                                    <ul>
                                                        {% for list in contact.lists.all %}
                                                            <li>{{ list.name }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <a href="{% url 'contact:create_list' %}">Create a List</a>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if contact.campaigns.exists %}
                                                    <ul>
                                                        {% for campaign in contact.campaigns.all %}
                                                            <li>{{ campaign.name }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <a href="{% url 'contact:create_campaign' %}">Create a Campaign</a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="9">No contacts available.</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone Number</th>
                                            <th>Created</th>
                                            <th>Contact Type</th>
                                            <th>Time Zone</th>
                                            <th>Lists</th>
                                            <th>Campaigns</th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        
                            <!-- Pagination -->
                            <nav aria-label="Page navigation">
                                <ul class="pagination">
                                    {% for i in page_range %}
                                        {% if i == page_number %}
                                            <li class="page-item active" aria-current="page">
                                                <span class="page-link">{{ i }}</span>
                                            </li>
                                        {% else %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                <!-- Scroll - vertical dynamic Ends-->
            </div>
        </div>
    </div>
                
    
    {% endblock body %}
        
    
    
    {% block js %}
    <script src="{% static 'manish/js/datatable/datatables/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'manish/js/datatable/datatables/datatable.custom.js' %}"></script>
    <script>
        const listName = "{{ list.name|escapejs }}";
    </script>    
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const steps = document.querySelectorAll(".step");
            const prevStepBtn = document.getElementById("prevStep");
            const nextStepBtn = document.getElementById("nextStep");
            const submitFormBtn = document.getElementById("submitForm");
            const fileInput = document.getElementById("file_upload");
            const mappingTable = document.getElementById("mapping-table");
            let currentStep = 0;
            let mappingData = {}; // Store mapping data
        
            // Update step visibility
            function updateStepVisibility() {
                steps.forEach((step, index) => {
                    step.classList.toggle("d-none", index !== currentStep);
                });
                prevStepBtn.disabled = currentStep === 0;
                nextStepBtn.classList.toggle("d-none", currentStep === steps.length - 1);
                submitFormBtn.classList.toggle("d-none", currentStep !== steps.length - 1);
            }
        
            // Handle file upload and proceed to step 2
            fileInput.addEventListener("change", function (event) {
                const file = event.target.files[0];
                if (file) {
                    const fileName = file.name;
                    const fileExtension = fileName.split(".").pop().toLowerCase();
                    const fileSizeMB = file.size / (1024 * 1024);
        
                    if (fileExtension !== "csv" && fileExtension !== "xlsx" && fileExtension !== "xls") {
                        alert("Invalid file type. Please upload a valid CSV file.");
                        fileInput.value = "";
                        return;
                    }
        
                    if (fileSizeMB > 30) {
                        alert("File size exceeds 30MB. Please upload a smaller file.");
                        fileInput.value = "";
                        return;
                    }
        
                    const formData = new FormData();
                    formData.append("file_upload", file);
        
                    $.ajax({
                        url: "/contact/extract/",
                        method: "POST",
                        data: formData,
                        processData: false,
                        contentType: false,
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                        success: function (response) {
                            mappingData = response.data;
                            populateMappingTable(response.data);
                            validateMappingFields();
                            currentStep++;
                            updateStepVisibility();
                        },
                        error: function () {
                            alert("Error processing the file.");
                        },
                    });
                }
            });
        
            // Populate mapping table
            function populateMappingTable(data) {
                mappingTable.innerHTML = "";
                const processedRows = data.values;
                const expectedFields = ['First Name', 'Last Name', 'Email', 'Phone', 'Contact Type']; // Expected fields to match
        
                data.headers.forEach((header, index) => {
                    const row = document.createElement("tr");
                    const headerCell = document.createElement("td");
                    headerCell.textContent = header;
                    row.appendChild(headerCell);
        
                    const valuesCell = document.createElement("td");
                    const values = processedRows[header] || [];
                    valuesCell.innerHTML = values.slice(0, 3).map(value => value || "-").join("<br>");
                    row.appendChild(valuesCell);
        
                    const statusCell = document.createElement("td");
                    if (expectedFields.includes(header)) {
                        statusCell.innerHTML = '<span class="ti-check-box badge badge-light-success">Mapped</span>';
                    } else {
                        statusCell.innerHTML = '<span class="icon-close badge badge-light-danger">Not Mapped</span>';
                    }
                    row.appendChild(statusCell);
        
                    const selectCell = document.createElement("td");
                    const select = document.createElement("select");
                    select.classList.add("form-select");
                    data.header_variables.forEach(variable => {
                        const option = document.createElement("option");
                        option.value = variable;
                        option.textContent = variable.replace(/_/g, " ");
                        if (data.header_variables[index] === variable) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    selectCell.appendChild(select);
                    row.appendChild(selectCell);
        
                    mappingTable.appendChild(row);
                });
            }
        
            // Validate email and phone number formats dynamically
            function validateMappingFields() {
                const rows = mappingTable.querySelectorAll("tr");
        
                rows.forEach(row => {
                    const select = row.querySelector("select");
                    const statusCell = row.querySelector("td:nth-child(3)"); // Status column
                    const headerCell = row.querySelector("td:nth-child(1)");
                    const header = headerCell?.textContent.trim();
        
                    if (select) {
                        select.addEventListener("change", function () {
                            const selectedVariable = select.value;
                            const dataValues = mappingData.values[header] || [];
                            let isValid = true;
        
                            if (selectedVariable === "email") {
                                // Validate email format
                                isValid = dataValues.every(value => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value));
                            } else if (selectedVariable === "phone number") {
                                // Validate phone number format
                                isValid = dataValues.every(value => /^\d+$/.test(value));
                            }
        
                            // Update status cell
                            if (isValid) {
                                statusCell.innerHTML = '<span class="ti-check-box badge badge-light-success">Mapped</span>';
                            } else {
                                statusCell.innerHTML = '<span class="icon-close badge badge-light-danger">Not Mapped</span>';
                            }
                        });
                    }
                });
            }
        
            // Handle next and previous steps
            nextStepBtn.addEventListener("click", function () {
                if (currentStep === 1 && !validateMapping()) {
                    alert("Please complete the mapping.");
                    return;
                }
                currentStep++;
                updateStepVisibility();
            });
        
            prevStepBtn.addEventListener("click", function () {
                currentStep--;
                updateStepVisibility();
            });
        
            // Validate mapping step
            function validateMapping() {
                let isValid = true;
                const selects = mappingTable.querySelectorAll("select");
                selects.forEach(select => {
                    if (!select.value) {
                        isValid = false;
                        select.classList.add("is-invalid");
                    } else {
                        select.classList.remove("is-invalid");
                    }
                });
                return isValid;
            }
        
            // Handle form submission
            submitFormBtn.addEventListener("click", function () {
                const selectedOption = document.querySelector('input[name="options"]:checked');
                if (!selectedOption) {
                    alert("Please select an action.");
                    return;
                }
        
                // Initialize postData
                const postData = {
                    headers: [],
                    header_variables: [],
                    selected_option: selectedOption.value,
                    list_name: listName,
                    data: {},
                };
        
                // Process mapping table rows
                const rows = mappingTable.querySelectorAll("tr");
                rows.forEach(row => {
                    const headerCell = row.querySelector("td:nth-child(1)");
                    const select = row.querySelector("select");
                    const header = headerCell?.textContent.trim();
                    const selectedVariable = select?.value;
        
                    if (header && selectedVariable) {
                        postData.headers.push(header);
                        postData.header_variables.push(selectedVariable);
        
                        // Map data values to the selected variable
                        const dataValues = mappingData.values[header] || [];
                        postData.data[selectedVariable] = dataValues;
                    }
                });
        
                $.ajax({
                    url: "/contact/create-bulk-list/",
                    method: "POST",
                    contentType: "application/json",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                    data: JSON.stringify(postData),
                    success: function (response) {
                        alert("Contacts created successfully!");
                        window.location.href = `/contact/lists/${response.listId}`;
                    },
                    error: function () {
                        alert("Error creating contacts.");
                    },
                });
            });
        
            // Initialize step visibility
            updateStepVisibility();
        }); 
    </script>
        
    {% endblock js %}
        
    